{% comment %} R+D Tabs — external JS in assets/rd-tabs.js {% endcomment %}

{{ 'component-image-with-text.css' | asset_url | stylesheet_tag }}

{%- style -%}
.rd-tabs-{{ section.id }}{
  --pill: {{ section.settings.pill_color }};
  width: calc(100vw - 11px) !important;
}
.rd-tabs-{{ section.id }} .rd-bg {
  position: relative; overflow: hidden;
  background: #000;
  {% if section.settings.bg_image %}
    background-image: url({{ section.settings.bg_image | image_url: width: 2400 }});
    background-size: cover; background-position: 50% 50%;
  {% endif %}
}
.rd-tabs-{{ section.id }} .inner {
  max-width: 1200px; margin: 0 auto; padding: 80px 0 120px;;
}
.rd-tabs-{{ section.id }} .heading {
  font-size: 28px; text-align: center; margin: 0 0 80px;
}
.rd-tabs-{{ section.id }} .pills {
  display: inline-flex; gap: 8px; border-radius: 999px;
  margin: 0 auto; position: relative;
    border: none;
    border-width: 2px;
    padding: 6pxx;
    background: linear-gradient(135deg, #444, #252525);
    -webkit-backdrop-filter: blur(40px);
    backdrop-filter: blur(40px);
    color: #fff;
    outline: none;
}
.rd-tabs-{{ section.id }} .pill-btn{
  position: relative; border: 0; background: transparent; color: inherit;
  padding: 8px 16px; border-radius: 999px; cursor: pointer; font: inherit;
}
.rd-tabs-{{ section.id }} .pill-btn.is-active{ color: #000; }
.rd-tabs-{{ section.id }} .pill-fill{
  position: absolute; inset: 4px auto 4px 4px; height: calc(100% - 8px);
  width: 0; border-radius: 999px; background: var(--pill);
  transition: transform .35s cubic-bezier(.22,.61,.36,1), width .35s cubic-bezier(.22,.61,.36,1), left .35s cubic-bezier(.22,.61,.36,1);
  z-index: -1;
}
.rd-tabs-{{ section.id }} .pills{ position: relative; }
.rd-tabs-{{ section.id }} .pills .rail{ position:absolute; inset:0; z-index:-2; border-radius:999px; }
.rd-tabs-{{ section.id }} .media-wrap{
  width: 100%; aspect-ratio: 16 / 9; background:#0b0b0b; border-radius: 16px; overflow:hidden;
  position: relative;
}
.rd-tabs-{{ section.id }} .media-wrap img{ width:100%; height:100%; object-fit:cover; display:block; }
.rd-tabs-{{ section.id }} .caption{
  margin: 14px auto 0; max-width: 760px;
  background: rgba(0,0,0,.55); border-radius: 12px; padding: 14px 16px;
  color: #fff; line-height: 1.35;
}
.rd-tabs-{{ section.id }} .eyebrow{
  text-align:center; opacity:.9; margin-bottom:10px; font-size:14px;
}

/* page-width compatibility w/ Ritual wrapper */
.section .rd-tabs-{{ section.id }}{ width:100%; }
{%- endstyle -%}

<section
  class="rd-tabs-{{ section.id }} color-{{ section.settings.color_scheme }}"
  data-component="rd-tabs"
  data-section-id="{{ section.id }}"
>
  <div class="rd-bg">
    <div class="inner">
      {% if section.settings.eyebrow != blank %}
        <div class="eyebrow">{{ section.settings.eyebrow }}</div>
      {% endif %}
      {% if section.settings.heading != blank %}
        <h2 class="heading inline-richtext {{ section.settings.heading_size }}">{{ section.settings.heading }}</h2>
      {% endif %}

      {%- assign active_index = 0 -%}
      {%- for b in section.blocks -%}
        {%- if b.type == 'tab' and b.settings.default_active -%}{% assign active_index = forloop.index0 %}{%- endif -%}
      {%- endfor -%}

      <!-- Pills -->
      <div class="pills"
           role="tablist"
           aria-label="{{ section.settings.heading | default: 'R&D tabs' | escape }}"
           data-active="{{ active_index }}">
        <div class="pill-fill" aria-hidden="true"></div>
        {% for block in section.blocks %}
          {% if block.type == 'tab' %}
            <button
              class="pill-btn{% if forloop.index0 == active_index %} is-active{% endif %}"
              data-idx="{{ forloop.index0 }}"
              role="tab"
              aria-selected="{% if forloop.index0 == active_index %}true{% else %}false{% endif %}"
              aria-controls="rd-panel-{{ section.id }}-{{ forloop.index0 }}"
              {{ block.shopify_attributes }}
            >
              {{ block.settings.title | escape }}
            </button>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Media -->
      <div class="media-wrap">
        {% for block in section.blocks %}
          {% if block.type == 'tab' %}
            {%- assign widths = '900, 1200, 1600, 2000, 2400' -%}
            {%- capture sizes -%}(min-width: 1200px) 1000px, 100vw{%- endcapture -%}
            {%- comment -%} compute fetchpriority safely {%- endcomment -%}
            {%- if forloop.index0 == active_index and section.index == 1 -%}
              {%- assign fetch_priority = 'high' -%}
            {%- else -%}
              {%- assign fetch_priority = 'auto' -%}
            {%- endif -%}

            <div class="panel" id="rd-panel-{{ section.id }}-{{ forloop.index0 }}"
                 role="tabpanel"
                 aria-labelledby="rd-tab-{{ section.id }}-{{ forloop.index0 }}"
                 style="{% if forloop.index0 == active_index %}opacity:1; visibility:visible;{% else %}opacity:0; visibility:hidden; position:absolute; inset:0;{% endif %} transition:opacity .35s ease;">
              {% if block.settings.image %}
                {{ block.settings.image | image_url: width: 2400 | image_tag: widths: widths, sizes: sizes, fetchpriority: fetch_priority }}
              {% else %}
                {{ 'hero-apparel-1' | placeholder_svg_tag: 'placeholder-svg' }}
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Caption -->
      {% for block in section.blocks %}
        {% if block.type == 'tab' %}
          <div class="caption"
               data-caption="{{ forloop.index0 }}"
               style="{% if forloop.index0 == active_index %}display:block{% else %}display:none{% endif %}">
            {% if block.settings.caption_title != blank %}
              <strong>• {{ block.settings.caption_title | escape }}</strong><br>
            {% endif %}
            {{ block.settings.caption | default: '' }}
          </div>
        {% endif %}
      {% endfor %}

    </div>
  </div>
</section>

{% schema %}
{
  "name": "R+D Tabs",
  "class": "section",
  "disabled_on": { "groups": ["header","footer"] },
  "settings": [
    { "type": "text", "id": "eyebrow", "label": "Eyebrow text", "default": "RESEARCH & DEVELOPMENT" },
    { "type": "inline_richtext", "id": "heading", "label": "Heading", "default": "Research ⊕ Development" },
    { "type": "select", "id": "heading_size", "label": "Heading size", "default": "h2",
      "options": [{ "value":"h3","label":"H3"},{ "value":"h2","label":"H2"},{ "value":"h1","label":"H1"},{ "value":"h0","label":"H0"}]
    },
    { "type": "image_picker", "id": "bg_image", "label": "Background image" },
    { "type": "color", "id": "pill_color", "label": "Pill color", "default": "#0FE694" },
    { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-1" }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "settings": [
        { "type": "text", "id": "title", "label": "Tab title", "default": "The Science" },
        { "type": "image_picker", "id": "image", "label": "Image" },
        { "type": "text", "id": "caption_title", "label": "Caption title", "default": "The Science" },
        { "type": "richtext", "id": "caption", "label": "Caption text", "default": "<p>Lorem ipsum dolor sit amet…</p>" },
        { "type": "checkbox", "id": "default_active", "label": "Start as active", "default": false }
      ]
    }
  ],
  "presets": [
    { "name": "R+D Tabs", "blocks": [{ "type":"tab" }, { "type":"tab" }, { "type":"tab" }] }
  ]
}
{% endschema %}
