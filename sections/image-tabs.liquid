{% comment %} Image Tabs — 50/50, vertical image slider, pill animation {% endcomment %}

{%- liquid
  if section.index == 1
    assign fetch_priority = 'high'
  else
    assign fetch_priority = 'auto'
  endif
-%}

{%- style -%}
  .tabs-img-{{ section.id }} { --pad-x: 24px; }
  .tabs-img-{{ section.id }} .inner {
    max-width: var(--page-width, 1200px);
    margin-inline: auto;
    padding-inline: var(--pad-x);
  }

  /* 50/50 grid on desktop */
  .tabs-img-{{ section.id }} .grid {
    display: grid;
    gap: 32px;
    grid-template-columns: 1fr;
    align-items: stretch;
  }
  @media (min-width: 990px) {
    .tabs-img-{{ section.id }} .grid { grid-template-columns: 1fr 1fr; }
    .tabs-img-{{ section.id }}.image-left .grid { grid-template-columns: 1fr 1fr; direction: rtl; }
    .tabs-img-{{ section.id }}.image-left .grid > * { direction: ltr; }
  }

  /* Head / subhead / body */
  .tabs-img-{{ section.id }} .heading { margin: 0 0 10px; }
  .tabs-img-{{ section.id }} .subheading {
    margin: 0 0 24px;
    opacity: .8;
    letter-spacing: .06em;
    text-transform: uppercase;
    font-size: clamp(12px, 1.8vw, 14px);
  }
  .tabs-img-{{ section.id }} .lead {
    margin-top: 20px;
    opacity: .8;
    line-height: 1.6;
  }

  /* Tabs list */
  .tabs-img-{{ section.id }} .tabs {
    border-top: 1px solid rgba(255,255,255,.15);
    border-bottom: 1px solid rgba(255,255,255,.15);
  }
  .tabs-img-{{ section.id }} .tabs .swiper-wrapper {
    display: flex; flex-direction: column; height: auto;
  }

  /* Row: pill + title in two columns so pill physically pushes text */
  .tabs-img-{{ section.id }} .tab {
    --pillw: 0px;
    display: grid;
    grid-template-columns: var(--pillw) 1fr;
    gap: 14px;
    align-items: center;
    padding-block: 14px;
    border-bottom: 1px solid rgba(255,255,255,.15);
    cursor: pointer; user-select: none;
    transition: grid-template-columns .45s cubic-bezier(.22,1,.36,1);
  }
  .tabs-img-{{ section.id }} .tab:last-child { border-bottom: 0; }

  /* Expanding pill */
  .tabs-img-{{ section.id }} .tab .pill {
    height: 28px; border-radius: 999px;
    background: {{ section.settings.pill_color }};
    transform-origin: left center;
    transform: scaleX(0.05);
    opacity: 0;
    transition: transform .45s cubic-bezier(.22,1,.36,1), opacity .25s ease;
  }
  .tabs-img-{{ section.id }} .tab.is-active { --pillw: 56px; }
  .tabs-img-{{ section.id }} .tab.is-active .pill { transform: scaleX(1); opacity: 1; }

  /* Titles */
  .tabs-img-{{ section.id }} .tab .title {
    font-weight: 600;
    letter-spacing: .08em;
    text-transform: uppercase;
    line-height: 1;
    font-size: clamp(26px, 5vw, 44px);
    text-decoration: none;
    color: rgb(var(--color-foreground, 255 255 255));
    opacity: .25;
    transition: opacity .25s ease;
  }
  .tabs-img-{{ section.id }} .tab.is-active .title { opacity: 1; }

  /* Image pane — fixed 1:1 and doesn’t overflow */
  .tabs-img-{{ section.id }} .image-pane {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    /* 1:1 box that scales with width */
    aspect-ratio: 1 / 1;
    isolation: isolate;
  }

  /* Vertical slider showing 1.2 slides */
  .tabs-img-{{ section.id }} .image-pane .swiper {
    height: 100%;
  }
  .tabs-img-{{ section.id }} .image-slide { height: auto; }
  .tabs-img-{{ section.id }} .image-slide .media {
    position: relative; width: 100%; height: 100%;
  }
  .tabs-img-{{ section.id }} .image-slide img {
    width: 100%; height: 100%;
    object-fit: cover; object-position: center;
    display: block;
  }

  /* Pagination: vertical right on desktop, centered row on mobile */
  .tabs-img-{{ section.id }} .image-pagination {
    position: absolute; right: 12px; bottom: 16px; z-index: 3;
    display: flex; flex-direction: column; gap: 8px; width: 10px !important;
  }
  .tabs-img-{{ section.id }} .image-pagination .swiper-pagination-bullet {
    width: 10px; height: 10px; border-radius: 10px;
    opacity: .4; background: #fff !important;
    transition: height .2s ease, opacity .2s ease;
  }
  .tabs-img-{{ section.id }} .image-pagination .swiper-pagination-bullet-active { opacity: 1; height: 46px; }

  @media (max-width: 989px) {
    .tabs-img-{{ section.id }} .image-pagination {
      left: 0; right: 0; bottom: 10px; flex-direction: row; justify-content: center; width: auto !important;
    }
  }

  /* Section padding + color scheme */
  .tabs-img-{{ section.id }} .pad {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }
  @media (min-width: 750px) {
    .tabs-img-{{ section.id }} .pad {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }
{%- endstyle -%}

<section
  class="tabs-img-{{ section.id }} color-{{ section.settings.section_color_scheme }} {% if section.settings.layout == 'image_left' %}image-left{% endif %}"
  data-section-id="{{ section.id }}"
>
  <div class="inner pad">
    {% if section.settings.heading != blank %}
      <h2 class="heading inline-richtext {{ section.settings.heading_size }}">{{ section.settings.heading }}</h2>
    {% endif %}
    {% if section.settings.subheading != blank %}
      <p class="subheading">{{ section.settings.subheading }}</p>
    {% endif %}

    <div class="grid">
      <!-- LEFT: Tabs -->
      <div>
        <div id="Tabs-{{ section.id }}" class="swiper tabs"
             data-autoplay="{{ section.settings.autoplay }}"
             data-delay="{{ section.settings.autoplay_delay | times: 1000 }}"
             data-loop="{{ section.settings.loop }}">
          <div class="swiper-wrapper">
            {% for block in section.blocks %}
              <div class="swiper-slide tab" {{ block.shopify_attributes }} data-index="{{ forloop.index0 }}" tabindex="0" role="button" aria-label="{{ block.settings.title | escape }}">
                <span class="pill" aria-hidden="true"></span>
                <a {% if block.settings.button_link == blank %} role="link" aria-disabled="true" {% else %} href="{{ block.settings.button_link }}" {% endif %} class="title">
                  {{ block.settings.title }}
                </a>
              </div>
            {% endfor %}
          </div>
        </div>

        {% if section.settings.body != blank %}
          <div class="lead rte">{{ section.settings.body }}</div>
        {% endif %}
      </div>

      <!-- RIGHT: Vertical image slider in a 1:1 frame -->
      <div>
        <div class="image-pane">
          <div id="Images-{{ section.id }}" class="swiper" aria-label="Image carousel">
            <div class="swiper-wrapper">
              {% for block in section.blocks %}
                <div class="swiper-slide image-slide">
                  <div class="media">
                    {% if block.settings.image != blank %}
                      {% assign widths = '600, 900, 1200, 1600, 2000' %}
                      {% capture sizes %}(min-width: 990px) 50vw, 100vw{% endcapture %}
                      {{ block.settings.image | image_url: width: 2000 | image_tag: sizes: sizes, widths: widths, fetchpriority: fetch_priority }}
                    {% else %}
                      {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            <div class="swiper-pagination image-pagination"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
/* Minimal per-section init (uses your swiper-loader.js) */
(function() {
  const id = {{ section.id | json }};
  const tabsEl  = document.getElementById('Tabs-' + id);
  const imgsEl  = document.getElementById('Images-' + id);
  if (!tabsEl || !imgsEl) return;

  const autoplay = tabsEl.getAttribute('data-autoplay') === 'true';
  const delay    = parseInt(tabsEl.getAttribute('data-delay') || '5000', 10);
  const loop     = tabsEl.getAttribute('data-loop') === 'true';

  loadSwiper(function() {
    // Tabs list (vertical, acts like a controller)
    const tabs = new Swiper(tabsEl, {
      direction: 'vertical',
      slidesPerView: 'auto',
      allowTouchMove: false,
      loop,
      speed: 500,
      autoplay: autoplay ? { delay, disableOnInteraction: false, pauseOnMouseEnter: true } : false
    });

    // Images: vertical, 1.2 slides visible (peek)
    const images = new Swiper(imgsEl, {
      direction: 'vertical',
      slidesPerView: 1.2,
      spaceBetween: 16,
      loop,
      speed: 600,
      pagination: { el: imgsEl.querySelector('.swiper-pagination'), clickable: true },
      autoplay: autoplay ? { delay, disableOnInteraction: false, pauseOnMouseEnter: true } : false
    });

    // Sync and active-state management
    const rows = tabsEl.querySelectorAll('.tab');
    const setActive = i => rows.forEach((r, idx) => r.classList.toggle('is-active', idx === i));
    const real = sw => (typeof sw.realIndex === 'number' ? sw.realIndex : sw.activeIndex);

    tabs.on('slideChange', () => setActive(real(tabs)));
    images.on('slideChange', () => setActive(real(images)));
    setActive(real(tabs));

    const go = i => {
      if (typeof tabs.slideToLoop === 'function') { tabs.slideToLoop(i); images.slideToLoop(i); }
      else { tabs.slideTo(i); images.slideTo(i); }
    };

    tabsEl.addEventListener('mouseenter', e => {
      const row = e.target.closest('.tab'); if (!row) return;
      const i = +row.dataset.index; if (!Number.isNaN(i)) go(i);
    }, true);

    tabsEl.addEventListener('click', e => {
      const row = e.target.closest('.tab'); if (!row || e.target.closest('a')) return;
      e.preventDefault();
      const i = +row.dataset.index; if (!Number.isNaN(i)) go(i);
    });
  });
})();
</script>

{% schema %}
{
  "name": "Image Tabs",
  "class": "section",
  "disabled_on": { "groups": ["header", "footer"] },
  "settings": [
    { "type": "inline_richtext", "id": "heading", "label": "Heading" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "A new era of sports protection" },
    { "type": "richtext", "id": "body", "label": "Body text", "default": "<p>We exist to revolutionise protective sports equipment &amp; keep you playing the sport you love. Longer.</p>" },
    { "type": "select", "id": "heading_size", "label": "Heading size", "default": "h2", "options": [
      { "value": "h2", "label": "H2" }, { "value": "h1", "label": "H1" }, { "value": "h0", "label": "H0" }
    ]},
    { "type": "select", "id": "layout", "label": "Layout (desktop)", "default": "image_right", "options": [
      { "value": "image_right", "label": "Image right" },
      { "value": "image_left",  "label": "Image left" }
    ]},
    { "type": "checkbox", "id": "autoplay", "label": "Autoplay", "default": true },
    { "type": "range", "id": "autoplay_delay", "label": "Autoplay delay (seconds)", "min": 2, "max": 15, "step": 1, "default": 5 },
    { "type": "checkbox", "id": "loop", "label": "Loop slides", "default": true },
    { "type": "color_scheme", "id": "section_color_scheme", "label": "Section color scheme", "default": "scheme-1" },
    { "type": "color", "id": "pill_color", "label": "Active pill color", "default": "#0FE694" },
    { "type": "range", "id": "padding_top", "min": 0, "max": 120, "step": 4, "unit": "px", "label": "Top padding", "default": 40 },
    { "type": "range", "id": "padding_bottom", "min": 0, "max": 120, "step": 4, "unit": "px", "label": "Bottom padding", "default": 40 }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "settings": [
        { "type": "text", "id": "title", "label": "Title", "default": "Iconic Design" },
        { "type": "text", "id": "button_label", "label": "Button label" },
        { "type": "url",  "id": "button_link", "label": "Button link" },
        { "type": "image_picker", "id": "image", "label": "Image" }
      ]
    }
  ],
  "presets": [{ "name": "Image Tabs", "blocks": [{ "type": "tab" }, { "type": "tab" }, { "type": "tab" }] }]
}
{% endschema %}
